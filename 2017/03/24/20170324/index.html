<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            lodash中cloneDeep源码学习 | 
        
        liuqisakuya&#39;s blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="liuqisakuya">
    <meta name="description" content="null">
    <meta name="keywords" content="null,面试">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="liuqisakuya&#39;s blog">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="lodash中cloneDeep源码学习 | liuqisakuya&#39;s blog">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="面试"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #EEE;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="/js/jquery.min.js"></script>
    <script src="/js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#cloneDeep的源码"><span class="post-toc-number">1.</span> <span class="post-toc-text">cloneDeep的源码</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#baseClone的源码"><span class="post-toc-number">2.</span> <span class="post-toc-text">baseClone的源码</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#定义类型"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">定义类型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#定义复制用的位掩码"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">定义复制用的位掩码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#检测是否为本身的属性"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">检测是否为本身的属性</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#initCloneByTag"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">initCloneByTag</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#initCloneArray"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">initCloneArray</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#baseClone的作用及函数的拷贝"><span class="post-toc-number">2.6.</span> <span class="post-toc-text">baseClone的作用及函数的拷贝</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#环对象的深拷贝"><span class="post-toc-number">3.</span> <span class="post-toc-text">环对象的深拷贝</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建一个简单的环对象"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">创建一个简单的环对象</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#baseclone中对于环对象处理的源码"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">baseclone中对于环对象处理的源码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#环对象拷贝过程"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">环对象拷贝过程</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Stack函数分析"><span class="post-toc-number">4.</span> <span class="post-toc-text">Stack函数分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ListCache"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">ListCache</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#ListCache的实例化过程"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">ListCache的实例化过程</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#第一次递归Stack的值"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">第一次递归Stack的值</span></a></li></ol></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                lodash中cloneDeep源码学习
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>liuqisakuya</strong>
        <span>3月 24, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/面试/">面试</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=lodash中cloneDeep源码学习&url=http://yoursite.com//2017/03/24/20170324/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=lodash中cloneDeep源码学习&url=http://yoursite.com//2017/03/24/20170324/index.html&via=liuqisakuya" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2017/03/24/20170324/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2017/03/24/20170324/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>  今天面试时，面试官让我手写一个深拷贝的实现，想了想思路，先判断类型，如果是对象或者数组这种引用类型，就遍历然后返回，如果嵌套了对象或者数组，递归调用自己来拷贝，但是写着却发现总有漏洞，查看资料，这篇文章<a href="http://jerryzou.com/posts/dive-into-deep-clone-in-javascript/" target="_blank" rel="external"><strong>深入剖析 JavaScript 的深复制</strong></a> 介绍了Underscore、lodash、jQuery以及文章作者自己实现的深复制功能，也给出了方法支持的对比,看到lodash的深复制实现比较好时，便去看了下源码，写下这篇文章来记录学习心得。</p>
<h3 id="cloneDeep的源码"><a href="#cloneDeep的源码" class="headerlink" title="cloneDeep的源码"></a>cloneDeep的源码</h3><pre><code>import baseClone from &apos;./.internal/baseClone.js&apos;

/** Used to compose bitmasks for cloning. */
const CLONE_DEEP_FLAG = 1
const CLONE_SYMBOLS_FLAG = 4

/**
 * This method is like `clone` except that it recursively clones `value`.
 *
 * @since 1.0.0
 * @category Lang
 * @param {*} value The value to recursively clone.
 * @returns {*} Returns the deep cloned value.
 * @see clone
 * @example
 *
 * const objects = [{ &apos;a&apos;: 1 }, { &apos;b&apos;: 2 }]
 *
 * const deep = cloneDeep(objects)
 * console.log(deep[0] === objects[0])
 * // =&gt; false
 */
function cloneDeep(value) {
  return baseClone(value, CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG)
}
</code></pre><h3 id="baseClone的源码"><a href="#baseClone的源码" class="headerlink" title="baseClone的源码"></a>baseClone的源码</h3><h4 id="定义类型"><a href="#定义类型" class="headerlink" title="定义类型"></a>定义类型</h4><p>找到baseClone.js,首先定义了各种类型采用Object的toString方法后返回的字符串，换行下面的都是ArrayBuffer类型</p>
<pre><code>/** `Object#toString` result references. */
const argsTag = &apos;[object Arguments]&apos;
const arrayTag = &apos;[object Array]&apos;
const boolTag = &apos;[object Boolean]&apos;
const dateTag = &apos;[object Date]&apos;
const errorTag = &apos;[object Error]&apos;
const funcTag = &apos;[object Function]&apos;
const genTag = &apos;[object GeneratorFunction]&apos;
const mapTag = &apos;[object Map]&apos;
const numberTag = &apos;[object Number]&apos;
const objectTag = &apos;[object Object]&apos;
const regexpTag = &apos;[object RegExp]&apos;
const setTag = &apos;[object Set]&apos;
const stringTag = &apos;[object String]&apos;
const symbolTag = &apos;[object Symbol]&apos;
const weakMapTag = &apos;[object WeakMap]&apos;
/** `ArrayBuffer`*/
const arrayBufferTag = &apos;[object ArrayBuffer]&apos;
const dataViewTag = &apos;[object DataView]&apos;
const float32Tag = &apos;[object Float32Array]&apos;
const float64Tag = &apos;[object Float64Array]&apos;
const int8Tag = &apos;[object Int8Array]&apos;
const int16Tag = &apos;[object Int16Array]&apos;
const int32Tag = &apos;[object Int32Array]&apos;
const uint8Tag = &apos;[object Uint8Array]&apos;
const uint8ClampedTag = &apos;[object Uint8ClampedArray]&apos;
const uint16Tag = &apos;[object Uint16Array]&apos;
const uint32Tag = &apos;[object Uint32Array]&apos;
</code></pre><h4 id="定义复制用的位掩码"><a href="#定义复制用的位掩码" class="headerlink" title="定义复制用的位掩码"></a>定义复制用的位掩码</h4><pre><code>/** Used to compose bitmasks for cloning. */
const CLONE_DEEP_FLAG = 1
const CLONE_FLAT_FLAG = 2
const CLONE_SYMBOLS_FLAG = 4
</code></pre><h4 id="检测是否为本身的属性"><a href="#检测是否为本身的属性" class="headerlink" title="检测是否为本身的属性"></a>检测是否为本身的属性</h4><pre><code>/** Used to check objects for own properties. */
const hasOwnProperty = Object.prototype.hasOwnProperty
</code></pre><h4 id="initCloneByTag"><a href="#initCloneByTag" class="headerlink" title="initCloneByTag"></a>initCloneByTag</h4><p>主要用来创建基本类型和ES6新增的那些类型的深复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Initializes an object clone based on its `toStringTag`.</span><br><span class="line"> *</span><br><span class="line"> * **Note:** This function only supports cloning values with tags of</span><br><span class="line"> * `Boolean`, `Date`, `Error`, `Number`, `RegExp`, or `String`.</span><br><span class="line"> *</span><br><span class="line"> * @private</span><br><span class="line"> * @param &#123;Object&#125; object The object to clone. </span><br><span class="line"> * @param &#123;string&#125; tag The `toStringTag` of the object to clone.</span><br><span class="line"> * @param &#123;Function&#125; cloneFunc The function to clone values.</span><br><span class="line"> * @param &#123;boolean&#125; [isDeep] Specify a deep clone.</span><br><span class="line"> * @returns &#123;Object&#125; Returns the initialized clone.</span><br><span class="line"> */</span><br><span class="line">function initCloneByTag(object, tag, cloneFunc, isDeep) &#123;</span><br><span class="line">// 定义被复制数据的构造类型</span><br><span class="line">  const Ctor = object.constructor</span><br><span class="line">  switch (tag) &#123;</span><br><span class="line">    case arrayBufferTag:</span><br><span class="line">      return cloneArrayBuffer(object)</span><br><span class="line">    case boolTag:</span><br><span class="line">    case dateTag:</span><br><span class="line">      return new Ctor(+object)</span><br><span class="line"></span><br><span class="line">    case dataViewTag:</span><br><span class="line">      return cloneDataView(object, isDeep)</span><br><span class="line"></span><br><span class="line">    case float32Tag: case float64Tag:</span><br><span class="line">    case int8Tag: case int16Tag: case int32Tag:</span><br><span class="line">    case uint8Tag: case uint8ClampedTag: case uint16Tag: case uint32Tag:</span><br><span class="line">      return cloneTypedArray(object, isDeep)</span><br><span class="line"></span><br><span class="line">    case mapTag:</span><br><span class="line">      return cloneMap(object, isDeep, cloneFunc)</span><br><span class="line"></span><br><span class="line">    case numberTag:</span><br><span class="line">    case stringTag:</span><br><span class="line">      return new Ctor(object)</span><br><span class="line"></span><br><span class="line">    case regexpTag:</span><br><span class="line">      return cloneRegExp(object)</span><br><span class="line"></span><br><span class="line">    case setTag:</span><br><span class="line">      return cloneSet(object, isDeep, cloneFunc)</span><br><span class="line"></span><br><span class="line">    case symbolTag:</span><br><span class="line">      return cloneSymbol(object)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="initCloneArray"><a href="#initCloneArray" class="headerlink" title="initCloneArray"></a>initCloneArray</h4><p>  主要用来创建数组的复制,exec具体参考<a href="http://www.cnblogs.com/heshan1992/p/6259171.html" target="_blank" rel="external">正则表达式中的exec和match方法的区别</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Initializes an array clone.</span><br><span class="line"> *</span><br><span class="line"> * @private</span><br><span class="line"> * @param &#123;Array&#125; array The array to clone.</span><br><span class="line"> * @returns &#123;Array&#125; Returns the initialized clone.</span><br><span class="line"> */</span><br><span class="line">function initCloneArray(array) &#123;</span><br><span class="line">  const &#123; length &#125; = array</span><br><span class="line">  // 创建一个length相同的稀疏数组</span><br><span class="line">  const result = new array.constructor(length)</span><br><span class="line"></span><br><span class="line">  // Add properties assigned by `RegExp#exec`.</span><br><span class="line">	  //判断数组是否为正则的exec方法所返回的数组</span><br><span class="line">  if (length &amp;&amp; typeof array[0] == &apos;string&apos; &amp;&amp; hasOwnProperty.call(array, &apos;index&apos;)) &#123;</span><br><span class="line">    result.index = array.index</span><br><span class="line">    result.input = array.input</span><br><span class="line">  &#125;</span><br><span class="line">  return result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="baseClone的作用及函数的拷贝"><a href="#baseClone的作用及函数的拷贝" class="headerlink" title="baseClone的作用及函数的拷贝"></a>baseClone的作用及函数的拷贝</h4><p>最后就是重点深拷贝的函数baseClone了，按tag类型进行分类，比较麻烦的是函数和环两种类型的拷贝,function和对象里面值为function的区别在注释里面的的 <strong>–function–</strong>分隔符里面<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * The base implementation of `clone` and `cloneDeep` which tracks</span><br><span class="line"> * traversed objects.</span><br><span class="line"> *</span><br><span class="line"> * @private</span><br><span class="line"> * @param &#123;*&#125; value The value to clone.</span><br><span class="line"> * @param &#123;boolean&#125; bitmask The bitmask flags.</span><br><span class="line"> *  1 - Deep clone</span><br><span class="line"> *  2 - Flatten inherited properties</span><br><span class="line"> *  4 - Clone symbols</span><br><span class="line"> * @param &#123;Function&#125; [customizer] The function to customize cloning.</span><br><span class="line"> * @param &#123;string&#125; [key] The key of `value`.</span><br><span class="line"> * @param &#123;Object&#125; [object] The parent object of `value`.</span><br><span class="line"> * @param &#123;Object&#125; [stack] Tracks traversed objects and their clone counterparts.</span><br><span class="line"> * @returns &#123;*&#125; Returns the cloned value.</span><br><span class="line"> */</span><br><span class="line">function baseClone(value, bitmask, customizer, key, object, stack) &#123;</span><br><span class="line">  // 定义保存拷贝数据的变量</span><br><span class="line">  let result</span><br><span class="line">  // 根据cloneDeep里面提供的默认值 定义位掩码 bitmask为5，当拷贝对象为Set/Map类时会改变bitmask的值</span><br><span class="line">  const isDeep = bitmask &amp; CLONE_DEEP_FLAG // 1</span><br><span class="line">  const isFlat = bitmask &amp; CLONE_FLAT_FLAG // 0</span><br><span class="line">  const isFull = bitmask &amp; CLONE_SYMBOLS_FLAG // 4</span><br><span class="line">  // 如果自定义的拷贝函数存在</span><br><span class="line">  if (customizer) &#123;</span><br><span class="line">    // &apos;step1&apos;</span><br><span class="line">    // 根据需要拷贝的值是否存在源对象来执行customizer</span><br><span class="line">    result = object ? customizer(value, key, object, stack) : customizer(value)</span><br><span class="line">  &#125;</span><br><span class="line">  // 如果result存在 代表自定义的拷贝函数已经执行</span><br><span class="line">  if (result !== undefined) &#123;</span><br><span class="line">  // &apos;step2&apos;</span><br><span class="line">    return result</span><br><span class="line">  &#125;</span><br><span class="line">  // isObject判断类型是否为对象，如果不是直接返回该值，用于拷贝基本类型和symbol</span><br><span class="line">  if (!isObject(value)) &#123;</span><br><span class="line">  // &apos;step3&apos;</span><br><span class="line">    return value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const isArr = Array.isArray(value)</span><br><span class="line">  if (isArr) &#123;</span><br><span class="line">  // &apos;step4&apos;</span><br><span class="line">    // 调用initCloneArray 创建稀疏数组</span><br><span class="line">    result = initCloneArray(value)</span><br><span class="line">    if (!isDeep) &#123;</span><br><span class="line">    // &apos;ste4-1&apos;</span><br><span class="line">      // 如果不需要深拷贝，调用copyArray对数组进行浅拷贝</span><br><span class="line">      return copyArray(value, result)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // &apos;step5&apos;</span><br><span class="line">    // 不是数组时,调用getTag获取value的类型</span><br><span class="line">    const tag = getTag(value)</span><br><span class="line">    // 判断是否为函数或者generator</span><br><span class="line">    const isFunc = tag == funcTag || tag == genTag</span><br><span class="line">    // isBuffer用来判断是否在node环境内 在lodash源码里面打印isBuffer.js的变量时，全局对象为Window</span><br><span class="line">    if (isBuffer(value)) &#123;</span><br><span class="line">	  // &apos;step5-1&apos;</span><br><span class="line">      return cloneBuffer(value, isDeep)</span><br><span class="line">    &#125;</span><br><span class="line">    //----------------------function------------------</span><br><span class="line">    // 如果是对象、arguments、不存在源对象的函数</span><br><span class="line">    if (tag == objectTag || tag == argsTag || (isFunc &amp;&amp; !object)) &#123;</span><br><span class="line">    // &apos;step5-2&apos;</span><br><span class="line">      // 如果是函数，且不存在源对象，将result定义为空对象，其他情况则调用initCloneObject</span><br><span class="line">      // ？？？ 但是当要拷贝的值为函数时，result返回的是空对象而不是函数本身，但是当函数是对象某个属性的值时，进入下面的else，从而可以复制函数</span><br><span class="line">      result = (isFlat || isFunc) ? &#123;&#125; : initCloneObject(value)</span><br><span class="line">      if (!isDeep) &#123;</span><br><span class="line">      // &apos;step5-2-1&apos;</span><br><span class="line">        return isFlat</span><br><span class="line">          ? copySymbolsIn(value, baseAssignIn(result, value))</span><br><span class="line">          : copySymbols(value, baseAssign(result, value))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    // &apos;step5-3&apos;</span><br><span class="line">      // 如果为函数切支持复制</span><br><span class="line">      if (!cloneableTags[tag]) &#123;</span><br><span class="line">      // &apos;step5-3-1&apos;</span><br><span class="line">        // 直接返回函数或者空对象</span><br><span class="line">        return object ? value : &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      //-----------------------function---------------------</span><br><span class="line">      // 调用initCloneByTag返回对应的值</span><br><span class="line">      result = initCloneByTag(value, tag, baseClone, isDeep)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(&apos;step6&apos;);</span><br><span class="line"> 	  // Check for circular references and return its corresponding clone.</span><br><span class="line">  // 当存在环的时候</span><br><span class="line">  stack || (stack = new Stack)</span><br><span class="line">  // 调用get方法判断是否存在value，不存在会返回undefined</span><br><span class="line">  const stacked = stack.get(value)</span><br><span class="line">  if (stacked) &#123;</span><br><span class="line">    return stacked</span><br><span class="line">  &#125;</span><br><span class="line">  stack.set(value, result)</span><br><span class="line"></span><br><span class="line">  const keysFunc = isFull</span><br><span class="line">    ? (isFlat ? getAllKeysIn : getAllKeys)</span><br><span class="line">    : (isFlat ? keysIn : keys)</span><br><span class="line"></span><br><span class="line">  const props = isArr ? undefined : keysFunc(value)</span><br><span class="line">  arrayEach(props || value, (subValue, key) =&gt; &#123;</span><br><span class="line">    if (props) &#123;</span><br><span class="line">      key = subValue</span><br><span class="line">      subValue = value[key]</span><br><span class="line">    &#125;</span><br><span class="line">    // Recursively populate clone (susceptible to call stack limits).</span><br><span class="line">    assignValue(result, key, baseClone(subValue, bitmask, customizer, key, value, stack))</span><br><span class="line">  &#125;)</span><br><span class="line">  return result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="环对象的深拷贝"><a href="#环对象的深拷贝" class="headerlink" title="环对象的深拷贝"></a>环对象的深拷贝</h3><h4 id="创建一个简单的环对象"><a href="#创建一个简单的环对象" class="headerlink" title="创建一个简单的环对象"></a>创建一个简单的环对象</h4><pre><code>let crc = {};
crc.a = crc;
</code></pre><h4 id="baseclone中对于环对象处理的源码"><a href="#baseclone中对于环对象处理的源码" class="headerlink" title="baseclone中对于环对象处理的源码"></a>baseclone中对于环对象处理的源码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// Check for circular references and return its corresponding clone.</span><br><span class="line">// 当存在环的时候</span><br><span class="line">stack || (stack = new Stack)</span><br><span class="line">// 调用get方法判断是否存在value，不存在会返回undefined</span><br><span class="line">const stacked = stack.get(value)</span><br><span class="line">  if (stacked) &#123;</span><br><span class="line">   // &apos;step6-1&apos;</span><br><span class="line">    return stacked;</span><br><span class="line">  &#125;</span><br><span class="line">  stack.set(value, result);</span><br><span class="line"></span><br><span class="line">  var keysFunc = isFull //isFull = 4, isFlat = 0</span><br><span class="line">    ? (isFlat ? getAllKeysIn : getAllKeys) </span><br><span class="line">    : (isFlat ? keysIn : keys);</span><br><span class="line">  // &apos;step7&apos;</span><br><span class="line">  var props = isArr ? undefined : keysFunc(value);</span><br><span class="line">  // props = [&apos;a&apos;]</span><br><span class="line">  arrayEach(props || value, function(subValue, key) &#123;</span><br><span class="line">    // &apos;step8&apos;</span><br><span class="line">    if (props) &#123;</span><br><span class="line">     // &apos;step8-1&apos;</span><br><span class="line">      key = subValue;</span><br><span class="line">      subValue = value[key];</span><br><span class="line">    &#125;</span><br><span class="line">    // Recursively populate clone (susceptible to call stack limits).</span><br><span class="line">    assignValue(result, key, baseClone(subValue, bitmask, customizer, key, value, stack));</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h4 id="环对象拷贝过程"><a href="#环对象拷贝过程" class="headerlink" title="环对象拷贝过程"></a>环对象拷贝过程</h4><ol>
<li>调用cloneDeep后，环对象先进入函数，进入step5-2， 根据之前的对象处理部分，会返回{}；</li>
<li>然后new Stack用来保存环对象，初始时不存在所以跳过step6-1,调用stack的set方法设置环对象，初始bitmark为5，计算得到isFull = 4，isFlat = 0，则keysFunc调用了getAllkeys方法；计算出props为[‘a’]；</li>
<li>在arrayEach方法中，此时props为数组，会调用传入的iteratee函数，函数接收三个参数，数组的value、index和传入的数组本身，进入step8-1后，设置key为传进来的subValue， 设置subValue为环对象的subValue属性，递归调用自身，作为传入assignValue函数的第三个参数，此时其他两个参数result为step5-2时 initCloneObject返回的{}，key为’a’；</li>
<li>递归调用自身时，注意最后传入的参数能进入step6-1 返回stack作为之前传入assignValue函数的第三个参数；以下为assignValue源码；</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function assignValue(object, key, value) &#123;</span><br><span class="line">  const objValue = object[key]</span><br><span class="line">  if (!(hasOwnProperty.call(object, key) &amp;&amp; eq(objValue, value)) ||</span><br><span class="line">	  (value === undefined &amp;&amp; !(key in object))) &#123;</span><br><span class="line">	baseAssignValue(object, key, value)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  if里面四个判断条件均为false，所以调用baseAssignValue返回复制后的环对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function baseAssignValue(object, key, value) &#123;</span><br><span class="line">  if (key == &apos;__proto__&apos;) &#123;</span><br><span class="line">    Object.defineProperty(object, key, &#123;</span><br><span class="line">      &apos;configurable&apos;: true,</span><br><span class="line">      &apos;enumerable&apos;: true,</span><br><span class="line">      &apos;value&apos;: value,</span><br><span class="line">      &apos;writable&apos;: true</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    object[key] = value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Stack函数分析"><a href="#Stack函数分析" class="headerlink" title="Stack函数分析"></a>Stack函数分析</h3><p>在上面，step6之后，调用了new Stack和stack的get、set方法，里面就是拷贝环对象麻烦的地方。<br>下面为baseClone里面，stack创建的流程；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stack || (stack = new Stack)</span><br><span class="line">// 调用get方法判断是否存在value，不存在会返回undefined</span><br><span class="line">const stacked = stack.get(value)</span><br><span class="line">if (stacked) &#123;</span><br><span class="line">  return stacked</span><br><span class="line">&#125;</span><br><span class="line">stack.set(value, result)</span><br></pre></td></tr></table></figure></p>
<h4 id="ListCache"><a href="#ListCache" class="headerlink" title="ListCache"></a>ListCache</h4><p>stack里面，源码如下,定义了constructor和五个方法，constructor里面定义了类的数据为ListCache的实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Stack &#123;</span><br><span class="line">  constructor(entries) &#123;</span><br><span class="line">    const data = this.__data__ = new ListCache(entries)</span><br><span class="line">    this.size = data.size</span><br><span class="line">  &#125;</span><br><span class="line">  clear() &#123;&#125;</span><br><span class="line">  delete(key) &#123;&#125;</span><br><span class="line">  get(key) &#123;&#125;  </span><br><span class="line">  has(key) &#123;&#125;  </span><br><span class="line">  set(key, value) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ListCache的实例化过程"><a href="#ListCache的实例化过程" class="headerlink" title="ListCache的实例化过程"></a>ListCache的实例化过程</h5><p>打开ListCache的源码,同样也是定义了constructor和五个方法，由于是新建的Stack类，则constructor里面的entries为undefined，length为0，调用了clear方法；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class ListCache &#123;</span><br><span class="line"></span><br><span class="line">  constructor(entries) &#123;</span><br><span class="line">    let index = -1</span><br><span class="line">    const length = entries == null ? 0 : entries.length</span><br><span class="line">    this.clear()</span><br><span class="line">    while (++index &lt; length) &#123;</span><br><span class="line">      const entry = entries[index]</span><br><span class="line">      this.set(entry[0], entry[1])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  clear() &#123;&#125;</span><br><span class="line">  delete(key) &#123;&#125;</span><br><span class="line">  get(key) &#123;&#125;</span><br><span class="line">  has(key) &#123;&#125;</span><br><span class="line">  set(key, value) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 看下clear，给ListCache设置了两个全局变量 <em>data</em>和size，<em>data</em>的结构为二维数组，初始值为[]；此后调用clear则为初始化全局属性；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clear() &#123;</span><br><span class="line">  this.__data__ = []</span><br><span class="line">  this.size = 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在baseClone中，new Stack后，会调用stack的get方法，看下源码；在constructor中定义了this.<em>data</em>指向ListCache,打开ListCache.get(),assocIndexOf会判断传入的二维数组data里面，是否有等于key的项，存在则返回索引index，不存在返回-1，功能类似indexOf；<br>初始data为[]，index为-1，get返回undefined；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Stack.get()</span><br><span class="line">get(key) &#123;</span><br><span class="line">  return this.__data__.get(key)</span><br><span class="line">&#125;</span><br><span class="line">// ListCache.get()</span><br><span class="line">get(key) &#123;</span><br><span class="line">  const data = this.__data__</span><br><span class="line">  const index = assocIndexOf(data, key)</span><br><span class="line">  return index &lt; 0 ? undefined : data[index][1]</span><br><span class="line">&#125;</span><br><span class="line">assocIndexOf(array, key) &#123;</span><br><span class="line">  let &#123; length &#125; = array</span><br><span class="line">  while (length--) &#123;</span><br><span class="line">    if (eq(array[length][0], key)) &#123;</span><br><span class="line">      return length</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return -1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来调用stack的set方法， key为环对象，value为空对象；pairs的值为[];返回整个Stack,打印了MapCache的调用栈，发现此次环对象crc的深拷贝中，stack并没有调用MapCache；</p>
<pre><code>MapCache    @    lodash.js:2152
memoize    @    lodash.js:10616
memoizeCapped    @    lodash.js:6508
runInContext    @    lodash.js:6798
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">set(key, value) &#123;</span><br><span class="line">  let data = this.__data__</span><br><span class="line">  if (data instanceof ListCache) &#123;</span><br><span class="line">    const pairs = data.__data__</span><br><span class="line">    if (!Map || (pairs.length &lt; LARGE_ARRAY_SIZE - 1)) &#123;</span><br><span class="line">      pairs.push([key, value])</span><br><span class="line">      this.size = ++data.size</span><br><span class="line">      return this </span><br><span class="line">    &#125;</span><br><span class="line">    data = this.__data__ = new MapCache(pairs)</span><br><span class="line">  &#125;</span><br><span class="line">  data.set(key, value)</span><br><span class="line">  this.size = data.size</span><br><span class="line">  return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前已经得出props为[‘a’],递归调用第13行的assignValue时，subValue的层数比需要拷贝的层数少了一层；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const keysFunc = isFull</span><br><span class="line">  ? (isFlat ? getAllKeysIn : getAllKeys)</span><br><span class="line">  : (isFlat ? keysIn : keys)</span><br><span class="line"></span><br><span class="line">const props = isArr ? undefined : keysFunc(value)</span><br><span class="line"></span><br><span class="line">arrayEach(props || value, (subValue, key) =&gt; &#123;</span><br><span class="line">  if (props) &#123;</span><br><span class="line">    key = subValue</span><br><span class="line">    subValue = value[key]</span><br><span class="line">  &#125;</span><br><span class="line">  // Recursively populate clone (susceptible to call stack limits).</span><br><span class="line">  assignValue(result, key, baseClone(subValue, bitmask, customizer, key, value, stack))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h5 id="第一次递归Stack的值"><a href="#第一次递归Stack的值" class="headerlink" title="第一次递归Stack的值"></a>第一次递归Stack的值</h5>
    

    
</div>


                

                <!-- Post Comments -->
                
                    




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/03/20/mianshi/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpg" alt="liuqisakuya's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        liuqi2208@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/About" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/liuqisakuya" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.png);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/profile.php?id=100012657061228" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.png);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://plus.google.com/u/0/101979608232235486497" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.png);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/liuqisakuya" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    
        <a href="https://www.zhihu.com/people/liuqisakuya" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-zhihu.png);">
                <span class="visuallyhidden">Zhihu</span>
            </button><!--
     --></a>
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;liuqisakuya's blog
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="/js/lazyload.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
